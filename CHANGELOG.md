# Changelog

## Unreleased
 - Task: plan-macos-support — Added Flutter macOS target with unsandboxed entitlements, placeholder mDNS/device-info channels, and README notes for the preview desktop build.
 - Task: firebase-secret-cleanup — Removed the tracked Android `google-services.json`, added an ignore and example template, and require developers to supply local Firebase config to keep keys out of git.
 - Task: firebase-api-key-rotation-script — Added a script to clone/rotate GCP API keys with copied restrictions, handles async key creation to capture key strings, and guides keeping outputs local.
 - Task: android-fgs-mic-fallback — Guarded microphone foreground-service start on Android 15/SDK 36 with a dataSync fallback so monitoring doesn’t crash when MIC FGS permissions are denied at runtime.
 - Task: linux-noise-ws-only — Allow Linux listeners to register websocket-only noise leases when FCM is unavailable, skip FCM pushes for ws-only subscriptions, and prefer the ws-only token during subscription renewal so noise events still flow over WebSocket.
 - Task: android-fgs-advertise — Deferred Android advertise-only foreground service starts when the app is backgrounded, surfaced a clear platform error instead of throwing, and retried pending starts on resume so mDNS ads recover once the activity is foreground.
 - Task: android-mdns-wait-identity — Wait for Android identity/session to load before stopping mDNS advertise attempts, retrying after a short delay and starting an advertise-only foreground service on Android so ads publish even when audio capture demand is zero.
 - Task: plan-sound-levels — Added monitor mic input gain (0–200%) applied to detection and streamed PCM, listener playback volume control (0–200%) with platform hooks (Android AudioTrack channel + Linux software gain), and UI sliders tied to persisted settings.
 - Task: monitor-input-device — Restored the recording device picker on the monitor dashboard, persisted the selected input, and passed the chosen Linux source into audio capture so microphone selection works again.
 - Task: plan-noise-subscriptions — Implemented pinned-fingerprint noise subscribe/unsubscribe HTTP endpoints with canonical JSON, per-device leased subscription storage (single active token per device), FCM fallback gated to offline listeners, cleanup of superseded/invalid tokens, and listener-side HTTP subscription/renewal with lease timers.
- Task: plan-noise-subscriptions — Bound monitor-side FCM token updates to the authenticated fingerprint (rejecting mismatched listenerId claims) so noise fallback tokens cannot be hijacked by spoofed device IDs.
- Task: plan-noise-subscriptions — Documented noise subscription/unsubscribe plan with leased FCM fallback when WebSocket is down, client mute switch, and pairing-bound token handling.
- Task: linux-notifications-init — Added Linux initialization and notification details for local alerts so desktop noise and pairing notifications work without runtime errors.
- Task: listener-unpair-on-remove — Added an mTLS /unpair endpoint that removes trusted listeners on the monitor, and the listener forget flow now attempts to unpair remotely before deleting local state (with tests).
- Task: android-hostname-default — Resolve Android device names via platform channel (Settings/Build fallback) when the hostname is localhost so new installs don’t default to “localhost”.
- Task: monitor-settings-dropdown — Allow persisted/custom min-duration and cooldown values in the monitor settings dropdowns (including the 800ms/8s defaults) so opening the sheet no longer hits a dropdown assertion.
- Task: plan-control-stream — Exposed a public FileIdentityStore.file helper so the debug shell can surface the on-disk identity path on desktop, fixing the debug_shell build error.
- Task: mtls-http-control — Switched HTTP control transport to mandatory mTLS, removed the custom nonce header handshake, pinned fingerprints via TLS, and removed the insecure HTTP fallback for pairing/health.
- Task: listener-qr-fallback — Handle missing/unsupported cameras in the listener QR flow with a friendly fallback plus manual QR JSON entry (validated parser + tests) so pairing works without mobile_scanner.
- Task: diag-logging — Added diagnostic info logging across control server/client handshakes, control channel message flow, PIN pairing, and mDNS advertise/browse (Dart + Android/iOS/Linux) to trace connection issues.
- Task: remove-wired-quic — Dropped the QUIC control transport wiring in favor of HTTP+WebSocket only, removed the native QUIC plugin dependency, renamed control transport types, and refreshed UI/docs to match.
- Task: cli-control-tools — Added P-256 identity/mTLS helpers plus a `tool/control_cli.dart` harness to run monitor/listener from the CLI with pairing/ping smoke tests.
- Task: plan-control-stream — Defaulted control transport to HTTP+WebSocket with nonce+signature handshake and `/health` probe (no `lastSeenAt`), pushed QUIC behind `CRIBCALL_ENABLE_QUIC`, added transport hints to QR/mDNS, and covered the HTTP path with health/connect tests.
- Task: rustup-toolchain — Exported ANDROID_SDK_ROOT/ANDROID_NDK_HOME defaults in the Nix dev shell so Cargokit Android builds can find the NDK.
- Task: rustup-toolchain — Updated flake dev shell to read rust-toolchain.toml, surface rustup-managed toolchain paths, and add bindgen/clang env for native Rust builds.
- Task: rustup-toolchain — Dropped the fenix Rust overlay from the dev shell so Rust installs are managed via rustup instead.
- Task: plan-control-stream — Fixed cribcall_quic loading on Darwin by preferring process/executable handles (static Cargokit outputs) with framework/dylib fallback and added Linux bundle-path fallback (`<exe>/lib/libcribcall_quic.so`) plus RFC8410-wrapped Ed25519 PKCS#8 keys to avoid cert_load_error during native QUIC startup across platforms.
- Task: plan-control-stream — Implemented QUIC control connection events plus a ControlChannel wrapper with send queueing, connection state/error mapping, and tests to kick off the plan’s code work.
- Task: plan-control-stream — Wired monitor QUIC server/controller startup with trusted listener allowlist and listener-side control client connect hook using the new ControlChannel scaffolding.
- Task: plan-control-stream — Added QUIC client/server debug logging (Rust + Dart) with idempotent logger init (Android logs tagged `cribcall_quic`) to trace connection setup/teardown and fingerprint checks for connection debugging.
- Task: plan-control-stream — Added a detailed control channel + WebRTC stream integration plan (QUIC wiring, pairing enforcement, heartbeat, and media handoff).
- Task: plan-control-stream — Hydrate listener PIN sessions from `PIN_REQUIRED` so PIN submissions no longer return `NO_SESSION`, keep attempts alive for control-channel retries, and cover the flow with a PIN_REQUIRED test.
- Task: presence-mdns — Auto-start monitor mDNS advertisements when monitoring is enabled and add a TTL-based heartbeat for discovered monitors so listener online/offline reflects current presence after pairing.
- Task: plan-control-stream — Moved vendored Cargokit to the repo root and updated Android/iOS/macOS/Linux build glue plus analysis excludes to point at the new location.
- Task: quic-cargokit (plan_quic) — Added Rust toolchain (rustc/cargo/rustfmt/clippy) and BoringSSL build deps to Nix dev shell to support quiche + Cargokit work.
- Task: quic-cargokit (plan_quic) — Implemented Rust/quiche Cargokit FFI plugin with multi-connection server/client loops, client-cert verification, trusted-listener enforcement via fingerprint allowlist, per-connection IDs surfaced to Dart, updated send API, identity-to-PEM helpers, and native QUIC transport wiring stubs for control channel.
- Task: remove-flutter-quic — Removed flutter_quic dependency and stubbed QUIC control transport pending a native implementation.
- Task: android-deploy-script — Added `bin/deploy_android.sh` to build Flutter APKs, install over ADB, and launch `com.cribcall.cribcall`.
- Task: quic-flutter-quic — Integrated flutter_quic for control transport scaffolding (client connect + server config), added PKCS#8 export for Ed25519 identities, and guarded init via RustLib (initial experiment later removed; see remove-flutter-quic).
- Task: remove-native-spake2 — Removed the optional SPAKE2+ native bindings (libspake2_ffi C shim, Android CMake wiring, platform method channels) and aligned PIN pairing UI to the Dart PAKE path.
- Task: mdns-native — Implemented mDNS advertise/browse via Android NSD, iOS NetService, and Linux (multicast_dns + avahi publish); wired real browse events into providers to persist last-known IPs.
- Task: pin-pairing-ui — Added PIN pairing controller with Dart PAKE plumbing, monitor PIN display, listener PIN entry sheet, and persisted trusted listeners/monitors with revoke confirmations.
- Task: settings-persistence — Added disk-backed monitor/listener settings with async controllers, monitor dashboard sliders/name editing/auto-stream selectors, listener notification defaults, and trusted monitor revocation + last-known-IP updates from mDNS browse (with tests).
- Task: linux-build-warnings — Relaxed Linux CMake flags to avoid treating plugin (json.hpp) warnings as errors so `flutter run -d linux` succeeds with flutter_secure_storage.
- Task: SPEC-boot — Scaffolded Flutter app, added QUIC control/pairing data models with canonical transcript + framing helpers, and built monitor/listener shells matching SPEC v0.2 (tests cover canonical JSON, HMAC auth tags, and frame parsing).
- Task: build-linux-sysprof — Added sysprof dev dependency to Nix shell and documented pkg-config fix for `sysprof-capture-4` when building Linux artifacts.
- Task: build-fix-linux — Updated CardTheme to CardThemeData and pulled Riverpod legacy providers so Flutter 3.38 Linux builds succeed; reran tests.
- Task: spec-state-models — Added SPEC-aligned domain models (QR payloads, mDNS ads, noise settings), Riverpod Notifier state for roles/settings, UI wiring, and unit tests for models/state defaults.
- Task: identity-ed25519 — Implemented Ed25519 self-signed X.509 generation with SHA-256 fingerprinting + subjectAltName (cribcall:<deviceId>), wired identity into dashboards, and added certificate parsing tests.
- Task: identity-storage-service — Added persisted identity repository (filesystem) with tests, service identity builder for QR/mDNS payloads, and UI wiring to render live pairing payloads.
- Task: sound-detector — Implemented RMS-based sound detector core with threshold/min-duration/cooldown per SPEC and added unit coverage.
- Task: qr-mdns-secure-store — Added QR scanning flow on listener, service identity QR rendering, mDNS channel stubs, secure identity storage abstraction (prefers secure storage on mobile), and tests for service identity and sound detection.
